{
  "hash": "bac06da833059b29b84811b01179c589",
  "result": {
    "markdown": "---\ntitle: Generate main timeline plot\nauthor: Charlotte Wickham\n---\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code .hidden}\nlibrary(ggExtra)\n```\n:::\n\n\n\n\n\n## Import and mutate\n\nGet data, discretize depth:\n\n\n\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_ign <- read_csv(\"../data/lapalma_ign.csv\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\nRows: 11347 Columns: 14\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr  (3): Event, Intensity, Location\ndbl  (8): Latitude, Longitude, Depth(km), Magnitude, Type Mag, Timestamp, Sw...\ndttm (1): DateTime\ndate (1): Date\ntime (1): Time\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n:::\n\n```{.r .cell-code .hidden}\ndf_ign <- df_ign |>\n  mutate(\n    Mag = floor(Magnitude),\n    Depth = case_when(\n      `Depth(km)` >= 28 ~ \"Deep (>28km)\",\n      `Depth(km)` >= 18 ~ \"Interchange (18km>x>28km)\",\n      TRUE ~ \"Shallow (< 18km)\"\n    ))\ndf_ign |> \n  select(DateTime, Mag, Magnitude, Depth, `Depth(km)`)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 11,347 × 5\n   DateTime              Mag Magnitude Depth                     `Depth(km)`\n   <dttm>              <dbl>     <dbl> <chr>                           <dbl>\n 1 2017-03-09 23:44:06     1       1.6 Interchange (18km>x>28km)        26  \n 2 2017-03-10 00:16:10     2       2   Interchange (18km>x>28km)        27  \n 3 2017-03-10 00:16:11     2       2.1 Interchange (18km>x>28km)        20  \n 4 2017-03-10 03:20:26     1       1.6 Deep (>28km)                     30  \n 5 2017-08-21 02:06:55     1       1.6 Shallow (< 18km)                  0  \n 6 2017-10-07 10:27:29     1       1.5 Interchange (18km>x>28km)        21.6\n 7 2017-10-07 13:03:25     2       2.7 Deep (>28km)                     28.2\n 8 2017-10-07 20:09:58     1       1.6 Interchange (18km>x>28km)        24.2\n 9 2017-10-07 23:06:16     1       1.5 Interchange (18km>x>28km)        24.4\n10 2017-10-08 01:23:02     2       2.6 Interchange (18km>x>28km)        26.3\n# ℹ 11,337 more rows\n```\n:::\n:::\n\n\n\n\n\nTime epochs: \n\n\n\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ncut_times <- ymd_hms(c(\"2021-09-11\", \"2021-09-19 14:13:00\", \"2021-10-01\", \"2021-12-01\", \"2021-12-31\", \"2022-01-01\"), truncated = 3)\nepochs <- tibble(\n  start = cut_times[-length(cut_times)], \n  end = cut_times[-1], \n  label = c(\"pre\", \"early\", \"phase1\", \"phase2\", \"phase3\"),\n  text = c('Pre\\nEruptive\\nSwarm', \n           'Early Eruptive\\nPhase',\n           'Main Eruptive Phase\\n(sustained gas and lava ejection)', \n           'Final Eruptive Phase\\n(reducing gas and lava ejection)',\n            NA\n  )\n)\n```\n:::\n\n\n\n\n\nReduce to time around eruption, and add magnitude categories:\n\n\n\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\nmag_breaks <- c(0, 1, 2, 3, 4, 6)\nmag_labels <- c(\"0 < M <= 1\",\"1 < M <= 2\",\"2 < M <= 3\",\"3 < M <= 4\",\"M > 4\")\ndf_erupt <- df_ign |>\n  filter(Date < as.Date(\"2022-01-01\") & Date > as.Date(\"2021-09-11\")) |>\n  mutate(Magnitude_categories = cut(Magnitude, \n    breaks = mag_breaks, labels = mag_labels, right = FALSE))\n```\n:::\n\n\n\n\n\nRough plot:\n\n\n\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_erupt |>\n  arrange(Magnitude) |> \n  ggplot(aes(DateTime, `Depth(km)`)) + \n  geom_point(aes(color = Magnitude, size = Magnitude), \n    alpha = 0.1) \n```\n\n::: {.cell-output-display}\n![](main-timeline_files/figure-jats/unnamed-chunk-5-1.png)\n:::\n:::\n\n\n\n\n\n## Publication plot\n\n\n\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ncolors <- c(\"#1f77b4\",\"#aec7e8\",\"#ff7f0e\",\"#ffbb78\",\"#2ca02c\",\"#98df8a\",\n  \"#d62728\",\"#ff9896\",\"#9467bd\",\"#c5b0d5\",\"#8c564b\",\"#c49c94\",\"#e377c2\",\n  \"#f7b6d2\",\"#7f7f7f\",\"#c7c7c7\",\"#bcbd22\",\"#dbdb8d\",\"#17becf\",\"#9edae5\")\n```\n:::\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\neruption <- ymd_hms(\"2021-09-19 14:13:00\")\ndate_axis_breaks <- as.Date(\"2021-10-15\") + months(rep(0:2, each = 2)) - \n      days(rep(c(14, 0), times = 3))\ndate_axis_breaks <- c(eruption, date_axis_breaks[-1])\n\n# Custom Magnitude Scale transform\ntrans_mag <- scales::trans_new(\n  name = \"Magnitude transformation\",\n  transform = \\(x) 3*2^(1.3*x),\n  inverse = \\(x) (1/1.3) * log2(x/3)\n)\n\n  \ndf_erupt |>\n  arrange(Magnitude) |> \n  ggplot(aes(DateTime, `Depth(km)`)) + \n  geom_point(aes(fill = Magnitude_categories, size = Magnitude,\n    alpha = Magnitude_categories), shape = 21, color = \"black\") +\n  geom_vline(xintercept = eruption, color = colors[7]) +\n  annotate(\"text\", x = eruption, y = 20, label = \"ERUPTION\", \n    color = colors[7], angle = 90, hjust = 1, vjust = -0.2, size = 6) +\n  annotate(\"rect\", xmin = epochs$start, xmax = epochs$end,\n    ymin = -Inf, ymax = Inf, fill = colors[c(1, 3, 5, 7, 7)], alpha = 0.1) + \n  annotate(\"text\", x =  epochs$start + 0.5*(epochs$end - epochs$start), y = -4, \n    label = epochs$text, color = colors[c(1, 3, 5, 7, NA)], size = 7) +\n  scale_y_continuous(\"Depth (km)\", trans = scales::reverse_trans(), \n    breaks = seq(0, 40, 10), limits = c( 45, -5), sec.axis = dup_axis()) +\n  scale_x_datetime(\"Eruption Timeline\", expand = c(0, 0), \n    date_labels = \"%Y-%m-%d\", breaks = date_axis_breaks) +\n  scale_fill_manual(\"Event Magnitude (M)\", values = colors[c(13, 17, 5, 3, 7)]) +\n  scale_alpha_manual(\"Event Magnitude (M)\", values = c(0.3, 0.4, 0.5, 0.6, 0.8)) +\n  scale_size(\"Event Magnitude (M)\", breaks = 1:5, labels = mag_labels, \n    trans = trans_mag) +\n  theme_bw(base_size = 20, base_family = \"Helvetica\") + \n  theme(\n    legend.position = c(0.01, 0.01), \n    legend.justification = c(\"left\", \"bottom\"),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    panel.border = element_blank(),\n    axis.line.x.bottom = element_line(color = \"grey50\"),\n    axis.title.y.right = element_blank(),\n    plot.title = element_text(hjust = 0.5, margin = margin(t = 20, b = 20))\n  ) +\n  labs(title = \"Recorded seismicity during the La Palma eruption 11 September - 15 December 2021 (INVOLCAN Dataset)\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\nWarning: Removed 1 rows containing missing values (`geom_point()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n```\nWarning: Removed 1 rows containing missing values (`geom_text()`).\n```\n:::\n\n::: {.cell-output-display}\n![Earthquakes preceeding and following the 2021 eruption.](main-timeline_files/figure-jats/fig-eq-timeline-1.png){#fig-eq-timeline}\n:::\n:::\n",
    "supporting": [
      "main-timeline_files/figure-jats"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}